# ROS2目标检测节点显示增强功能使用说明

## 概述

本次更新为ROS2自动瞄准系统的target_detect.py节点添加了增强的可视化显示功能和改进的日志系统，提升了调试和监控能力。

## 新增功能

### 1. 多窗口可视化显示

#### 主检测结果窗口 - "Target Detection Result"
- **功能**: 显示完整的目标检测结果
- **内容**: 
  - 原始图像
  - 检测到的嵌套矩形（外层绿色，内层蓝色）
  - 检测到的目标圆形（黄色圆圈）
  - 帧率显示（左上角）
  - 检测状态文字（右上角，英文显示）
    - "Target Detected" - 绿色（矩形和圆形都检测到）
    - "Rectangle Detected" - 黄色（仅检测到矩形）
    - "No Target" - 红色（未检测到目标）

#### 矩形检测调试窗口 - "Rectangle Detection Debug"
- **功能**: 显示矩形检测的中间处理结果
- **内容**:
  - 所有候选矩形（蓝色边框）
  - 嵌套矩形对（外层绿色，内层红色）
  - 矩形ID和面积信息
  - 检测统计信息
    - "Rectangles Found: X" - 找到的矩形数量
    - "Nested Pair: Found/Not Found" - 嵌套对状态

#### 圆形检测调试窗口 - "Circle Detection Debug"
- **功能**: 显示圆形检测的中间处理结果
- **内容**:
  - 所有候选圆形（黄色圆圈）
  - 靶心圆形（红色，标记"BULLSEYE"）
  - 目标圆形（蓝色，标记"TARGET"）
  - 最终目标圆形（绿色，标记"FINAL TARGET"）
  - 检测统计信息
    - "Total Contours: X" - 总轮廓数
    - "Candidate Circles: X" - 候选圆形数
    - "Target Circles (R:90-120): X" - 目标圆形数

### 2. 增强的日志系统

#### 启动脚本改进
- **run.sh**: 个别节点启动方式，支持彩色日志输出
- **start_with_launch.sh**: Launch文件启动方式，支持统一日志管理

#### 日志功能特性
- **实时终端显示**: 带颜色标识的日志输出
  - 绿色: INFO级别日志
  - 黄色: WARN级别日志
  - 红色: ERROR级别日志
  - 青色: DEBUG级别日志
- **文件保存**: 自动保存到logs目录
  - 按节点分类保存: `节点名_时间戳.log`
  - 主日志文件: `main_时间戳.log`
  - 包含完整的时间戳和节点信息

## 使用方法

### 启动系统

#### 方法1: 使用run.sh（推荐用于调试）
```bash
chmod +x run.sh
./run.sh
```

#### 方法2: 使用start_with_launch.sh
```bash
chmod +x start_with_launch.sh
./start_with_launch.sh
```

### 查看显示窗口

启动系统后，如果连接了显示器，将自动显示三个OpenCV窗口：
1. **Target Detection Result** - 主结果窗口
2. **Rectangle Detection Debug** - 矩形检测调试窗口
3. **Circle Detection Debug** - 圆形检测调试窗口

### 查看日志

#### 实时查看
日志会实时显示在终端中，不同级别的日志有不同颜色标识。

#### 查看历史日志
```bash
# 查看日志目录
ls logs/

# 查看特定节点日志
cat logs/target_detect_2025-07-31_13-27-20.log

# 查看主日志
cat logs/main_2025-07-31_13-27-20.log

# 实时监控日志
tail -f logs/target_detect_*.log
```

## 代码修改说明

### target_detect.py主要修改

1. **detect_nested_rectangles函数**:
   - 添加了rect_debug_img参数，用于调试显示
   - 在调试图像上绘制所有候选矩形和嵌套对
   - 添加检测统计信息显示

2. **detect_circles函数**:
   - 添加了circle_debug_img参数，用于调试显示
   - 在调试图像上绘制检测过程中的所有圆形
   - 添加详细的检测统计和状态信息

3. **image_callback函数**:
   - 集成三个显示窗口
   - 添加检测状态文字显示（右上角）
   - 改进了日志输出，包含更多调试信息

### 启动脚本修改

1. **run.sh**:
   - 添加了彩色日志输出功能
   - 改进了节点启动和监控逻辑
   - 增强了进程管理和清理功能

2. **start_with_launch.sh**:
   - 添加了日志处理和颜色显示
   - 改进了错误处理和进程清理

## 测试验证

### 功能测试脚本

提供了两个测试脚本：

1. **test_target_detect.py**: 测试目标检测功能
   - 创建模拟测试图像
   - 验证矩形和圆形检测功能
   - 测试多窗口显示功能

2. **test_logging.py**: 测试日志功能
   - 模拟节点输出
   - 验证日志记录和显示功能

### 运行测试
```bash
# 测试目标检测功能
python test_target_detect.py

# 测试日志功能
python test_logging.py target_detect
```

## 注意事项

1. **显示环境**: 需要连接显示器或支持X11转发的SSH连接才能看到OpenCV窗口
2. **性能影响**: 多窗口显示会增加一定的计算开销，在生产环境中可以选择性关闭调试窗口
3. **日志管理**: 日志文件会持续增长，建议定期清理旧日志文件
4. **权限设置**: 确保启动脚本有执行权限

## 故障排除

### 常见问题

1. **无法显示窗口**:
   - 检查是否连接了显示器
   - 确认X11环境配置正确
   - 验证OpenCV安装是否完整

2. **日志文件未生成**:
   - 检查logs目录权限
   - 确认启动脚本执行权限
   - 查看终端错误信息

3. **节点启动失败**:
   - 检查ROS2环境配置
   - 确认功能包已正确构建
   - 查看具体错误日志

### 调试建议

1. 使用test_target_detect.py验证基本功能
2. 检查日志文件中的详细错误信息
3. 逐个启动节点定位问题节点
4. 使用ROS2命令行工具检查节点状态

## 更新历史

- **2025-07-31**: 初始版本发布
  - 添加多窗口可视化显示功能
  - 改进日志系统
  - 添加测试脚本和文档

---

如有问题或建议，请查看日志文件或联系开发团队。